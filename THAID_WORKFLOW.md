# ThaID Integration: System Workflow Summary

‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏™‡∏£‡∏∏‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô (Authentication) ‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö **ThaID** ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏™‡∏ñ‡∏≤‡∏õ‡∏±‡∏ï‡∏¢‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏ö‡∏ö **Backend-Delegated** (‡πÉ‡∏´‡πâ Backend ‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)

## üìå Concept: "Frontend ‡∏£‡∏±‡∏ö Code, Backend ‡πÅ‡∏•‡∏Å Token"
‡πÄ‡∏£‡∏≤‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡πâ **Frontend** ‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏Ñ‡πà "‡∏û‡∏≤ User ‡πÑ‡∏õ" ‡πÅ‡∏•‡∏∞ "‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏ù‡∏≤‡∏Å (Code) ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤" ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ù‡∏±‡πà‡∏á **Backend** ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î

## üîÑ Workflow Diagram
```mermaid
sequenceDiagram
    participant User
    participant Frontend as Frontend (Next.js Client)
    participant AuthJS as Next.js Server (Auth.js)
    participant Backend as Main Backend API
    participant ThaID as ThaID System
    participant SOAP as Internal SOAP API

    Note over User, Frontend: 1. Initiation
    User->>Frontend: ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "Login with ThaID"
    Frontend->>ThaID: Redirect ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ThaID (‡∏™‡πà‡∏á Client ID)

    Note over User, ThaID: 2. Authentication
    User->>ThaID: ‡∏™‡πÅ‡∏Å‡∏ô QR / ‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
    ThaID-->>Frontend: Redirect ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏° param "?code=..."

    Note over Frontend, AuthJS: 3. Delegation
    Frontend->>AuthJS: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å signIn('credentials', { code })
    
    Note over AuthJS, Backend: 4. Verification (Server-to-Server)
    AuthJS->>Backend: ‡∏™‡πà‡∏á POST /api/thaid-login { code }
    
    Backend->>ThaID: ‡πÅ‡∏•‡∏Å Code ‡πÄ‡∏õ‡πá‡∏ô Access Token
    ThaID-->>Backend: ‡∏™‡πà‡∏á Token + User Profile (PID)
    
    Backend->>SOAP: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Check PID)
    SOAP-->>Backend: Result (Active/Inactive)

    Note over Backend, AuthJS: 5. Completion
    Alt Verification Passed
        Backend-->>AuthJS: ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User Profile + Role
        AuthJS-->>Frontend: ‡∏™‡∏£‡πâ‡∏≤‡∏á Session Cookie (HttpOnly) & Redirect ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤ Admin
    Else Failed
        Backend-->>AuthJS: Error (Unauthorized)
        AuthJS-->>Frontend: ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Login Failed
    End
```

## üìù ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î

### 1. Initiation (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)
*   **‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô:** ‡∏´‡∏ô‡πâ‡∏≤ `/login`
*   **‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:** User ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Login ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á Link ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏ `client_id` ‡πÅ‡∏•‡∏∞ `redirect_uri` ‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏≤ User ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏Ç‡∏≠‡∏á ThaID

### 2. Authentication (‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô)
*   **‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô:** ‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå ThaID (`imauth.bora.dopa.go.th`)
*   **‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:** User ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏ï‡∏≤‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô DOPA (IAL) ‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏∏‡πà‡∏á‡∏¢‡∏≤‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ

### 3. Delegation (‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏•‡∏±‡∏ö)
*   **‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô:** ‡∏´‡∏ô‡πâ‡∏≤ `/auth/callback`
*   **‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:** ‡πÄ‡∏°‡∏∑‡πà‡∏≠ ThaID ‡∏™‡πà‡∏á User ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏° `code`, ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏î‡∏∂‡∏á `code` ‡∏ô‡∏±‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ Next.js Server ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡∏ú‡πà‡∏≤‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô `signIn` ‡∏Ç‡∏≠‡∏á Auth.js

### 4. Verification (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå - ‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ‚ù§Ô∏è)
*   **‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô:** `auth.config.ts` (Next.js) ‡πÅ‡∏•‡∏∞ **Main Backend**
*   **‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:**
    1.  Next.js ‡∏£‡∏±‡∏ö `code` ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ **Main Backend** (API ‡∏ó‡∏µ‡πà‡∏û‡∏µ‡πà Backend ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ß‡πâ)
    2.  **Main Backend** ‡πÄ‡∏≠‡∏≤ `code` ‡πÑ‡∏õ‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö ThaID ‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (PID)
    3.  **Main Backend** ‡πÄ‡∏≠‡∏≤ PID ‡πÑ‡∏õ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö HR (SOAP API) ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏´‡∏°
    4.  ‡∏ñ‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏°‡∏î -> Backend ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User (‡∏ä‡∏∑‡πà‡∏≠, Role) ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏´‡πâ Next.js

### 5. Completion (‡∏™‡∏£‡πâ‡∏≤‡∏á Session)
*   **‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô:** Browser ‡∏Ç‡∏≠‡∏á User
*   **‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:** Auth.js ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User ‡∏à‡∏≤‡∏Å Backend ‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á **Encrypted HttpOnly Cookie** ‡∏ù‡∏±‡∏á‡πÉ‡∏ô Browser ‡∏Ç‡∏≠‡∏á User ‡∏ó‡∏≥‡πÉ‡∏´‡πâ User ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤ `/admin` ‡∏´‡∏£‡∏∑‡∏≠ `/downloads` ‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢

---
**‚úÖ ‡∏Ç‡πâ‡∏≠‡∏î‡∏µ‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ:**
1.  **Secure:** `Client Secret` ‡πÅ‡∏•‡∏∞ Logic ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ SOAP ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà Backend ‡πÑ‡∏°‡πà‡∏´‡∏•‡∏∏‡∏î‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Frontend ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô
2.  **Standard:** ‡πÉ‡∏ä‡πâ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô OIDC ‡πÅ‡∏•‡∏∞ Auth.js ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Session ‡∏ó‡∏≥‡πÉ‡∏´‡πâ Maintenance ‡∏á‡πà‡∏≤‡∏¢
3.  **Separation of Concerns:** Frontend ‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏Ñ‡πà UI, Backend ‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Logic ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÅ‡∏ö‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ô‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
